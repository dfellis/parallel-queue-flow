function parallel(parallelism){if(!parallelism)parallelism=Infinity;function parallelQ(nameOrArray){this.qType=parallelQ;var eventHandlers={};var queue=[];var handler=undefined;var openQueue=[];this.on=function on(eventName,handler){eventHandlers[eventName]=eventHandlers[eventName]instanceof Array?eventHandlers[eventName]:[];eventHandlers[eventName].push(handler);return this};this.fire=function fire(eventName){var newArgs=Array.prototype.slice.call(arguments,1,arguments.length-1);var callback=arguments[arguments.length-1]instanceof Function?arguments[arguments.length-1]:function(){};if(!eventHandlers){callback(false)}else if(eventHandlers[eventName]){var total=eventHandlers[eventName].length,count=0,finalResult=true;eventHandlers[eventName].forEach(function(newArgs,handler){if(!handler instanceof Function)return count++;if(parallelQ.q.isAsync(handler,newArgs.length+1)){newArgs.push(function(result){if(result===false)finalResult=result;count++;if(total==count)callback(finalResult)});handler.apply(this,newArgs)}else{var result=handler.apply(this,newArgs);if(result===false)finalResult=result;count++;if(total==count)callback(finalResult)}}.bind(this,newArgs))}else{callback(true)}}.bind(this);this.clear=function clear(eventName){eventHandlers[eventName]=[]};this.setHandler=function setHandler(handlerFunc){handler=handlerFunc;if(queue&&queue.length>0)this.push();return this};var handlerCallback=function handlerCallback(openQueueStruct,done){openQueueStruct.done=done;var currStruct=openQueue[0];while(!!currStruct&&currStruct.done instanceof Function){currStruct.done();openQueue.shift();currStruct=openQueue[0]}if(openQueue.length==0&&queue.length==0){this.fire("empty")}else{this.push()}}.bind(this);var enqueueItems=function enqueueItems(){var numToProcess=parallelism-openQueue.length>queue.length?queue.length:parallelism-openQueue.length;for(var i=0;i<numToProcess;i++){var value=queue[0];this.fire("pull",value,function(result){if(result){var openQueueStruct={done:false};openQueue.push(openQueueStruct);process.nextTick(handler.bind(this,queue.shift(),handlerCallback.bind(this,openQueueStruct)))}}.bind(this))}}.bind(this);this.push=function push(){var values=Array.prototype.slice.call(arguments,0);this.fire("push",values,function(result){if(result===false)return;if(!!handler&&openQueue.length<parallelism){queue.push.apply(queue,values);enqueueItems()}else{queue.push.apply(queue,values)}}.bind(this));return this};this.close=function close(){this.fire("close",function(result){if(result){this.clear("push");this.on("push",function(){return false});var flushQueue=function(){var tempHandler=handler;handler=undefined;eventHandlers=undefined;queue=undefined;if(this.namedQueues)Object.keys(this.namedQueues).forEach(function(queue){if(this.namedQueues[queue]===this)delete this.namedQueues[queue]}.bind(this));delete this;if(tempHandler instanceof Function){process.nextTick(tempHandler.bind(null,"close"))}}.bind(this);if(queue&&!queue.length)process.nextTick(flushQueue.bind(this));if(queue&&queue.length){this.clear("empty");this.on("empty",flushQueue.bind(this))}}}.bind(this));return this}.bind(this);this.kill=function kill(){this.fire("kill");var tempHandler=handler;handler=undefined;eventHandlers={};queue=undefined;if(this.namedQueues)Object.keys(this.namedQueues).forEach(function(queue){if(this.namedQueues[queue]===this)delete this.namedQueues[queue]}.bind(this));delete this;if(tempHandler instanceof Function){tempHandler("kill")}};if(nameOrArray instanceof Array){this.push.apply(this,nameOrArray);if(queue.length>0)this.on("empty",this.close.bind(this))}return this}if(module&&module.exports){var q=global.q&&!!q?q:require("queue-flow");parallelQ.prototype=q.Q.prototype;parallelQ.q=q}else{parallelQ.prototype=q.Q.prototype;parallelQ.q=q}return parallelQ}if(module&&module.exports){module.exports=parallel}